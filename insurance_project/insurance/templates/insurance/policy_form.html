{% extends 'insurance/base.html' %}

{% block title %}
    {% if form.instance.id %}
        Editace sjednaného pojištění
    {% else %}
        Výběr pojištění
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container">
        <h1>
            {% if form.instance.id %}
                Editace sjednaného pojištění
            {% else %}
                Výběr pojištění
            {% endif %}
        </h1>
        <form method="post" class="form-horizontal">
            {% csrf_token %}

            <div class="form-row">
                <div class="form-group col-md-12">
                    {{ form.insured_person.label_tag }}
                    {{ form.insured_person }}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    <label for="id_insurance_coverage">Pojistné krytí:</label>
                    <select id="id_insurance_coverage" name="insurance_coverage" class="form-control">
                        {% for coverage in form.fields.insurance_coverage.queryset %}
                        <option value="{{ coverage.id }}" data-premium="{{ coverage.premium }}">{{ coverage }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    {{ form.start_date.label_tag }}
                    {{ form.start_date }}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    {{ form.end_date.label_tag }}
                    {{ form.end_date }}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    <p id="premium-label">Roční pojistné: <span id="premium-display">0</span> Kč</p>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    <button type="submit" class="btn btn-primary">
                        {% if form.instance.id %}
                            Potvrdit změny
                        {% else %}
                            Potvrdit
                        {% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('id_start_date');
            const endDateInput = document.getElementById('id_end_date');
            const premiumDisplay = document.getElementById('premium-display');
            const coverageSelect = document.getElementById('id_insurance_coverage');

            function updateEndDate() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setFullYear(startDate.getFullYear() + 1);
                endDateInput.value = endDate.toISOString().split('T')[0];
            }

            startDateInput.addEventListener('change', updateEndDate);

            coverageSelect.addEventListener('change', function() {
                const selectedOption = coverageSelect.options[coverageSelect.selectedIndex];
                const premiumValue = selectedOption.getAttribute('data-premium');
                premiumDisplay.textContent = premiumValue ? parseFloat(premiumValue).toFixed(0) : '0';
            });

            // Inicializace hodnoty pojistného
            const selectedOptionInitial = coverageSelect.options[coverageSelect.selectedIndex];
            const initialPremiumValue = selectedOptionInitial.getAttribute('data-premium');
            premiumDisplay.textContent = initialPremiumValue ? parseFloat(initialPremiumValue).toFixed(0) : '0';

            // Inicializace end_date při načtení stránky
            if (!endDateInput.value) {
                updateEndDate();
            }
        });
    </script>
{% endblock %}