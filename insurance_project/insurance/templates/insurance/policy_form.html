{% extends 'insurance/base.html' %}

{% block title %}
    {% if form.instance.id %}
        Editace sjednaného pojištění
    {% else %}
        Výběr pojištění
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container">
        <h1>
            {% if form.instance.id %}
                Editace sjednaného pojištění
            {% else %}
                Výběr pojištění
            {% endif %}
        </h1>

        <form method="post" class="form-horizontal">
            {% csrf_token %}

            <div class="form-row">
                <div class="form-group col-md-12">
                    <label for="id_insured_person">Pojištěná osoba:</label>
                    {% if not insured_person %}
                        <select id="id_insured_person" name="insured_person" class="form-control custom-select-style">
                            <option value="" selected disabled>Vyberte pojištěnou osobu</option>
                            {% for person in form.fields.insured_person.queryset %}
                            <option value="{{ person.id }}" {% if form.initial.insured_person == person.id %}selected {% endif %}>
                                {{ person.first_name }} {{ person.last_name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <input type="text" class="form-control" value="{{ insured_person.first_name }} {{ insured_person.last_name }}" readonly>
                        <input type="hidden" name="insured_person" value="{{ insured_person.id }}">
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    <label for="id_insurance_coverage">Pojistné krytí:</label>
                    {% if insurance_coverage %}
                        <input type="text" class="form-control" value="{{ insurance_coverage.name }}" readonly>
                        <input type="hidden" name="insurance_coverage" value="{{ insurance_coverage.id }}">
                    {% else %}
                        <select id="id_insurance_coverage" name="insurance_coverage" class="form-control custom-select-style">
                            <option value="" selected disabled>Vyberte pojistné krytí</option>
                            {% for coverage in form.fields.insurance_coverage.queryset %}
                            <option value="{{ coverage.id }}" data-premium="{{ coverage.premium }}"
                                    {% if form.initial.insurance_coverage == coverage.id %}selected {% endif %}>
                                {{ coverage }}
                            </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    {{ form.start_date.label_tag }}
                    {{ form.start_date }}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    {{ form.end_date.label_tag }}
                    {{ form.end_date }}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    <label for="id_premium">Roční pojistné:</label>
                    <input type="text" class="form-control" id="id_premium" name="premium"
                           value="{% if insurance_coverage %}{{ insurance_coverage.premium|floatformat:0 }},- Kč{% elif form.instance.premium %}{{ form.instance.premium|floatformat:0 }},- Kč{% endif %}" readonly>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    <button type="submit" class="btn btn-primary">
                        {% if form.instance.id %}
                            Potvrdit změny
                        {% else %}
                            Potvrdit
                        {% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('id_start_date');
            const endDateInput = document.getElementById('id_end_date');
            const coverageSelect = document.getElementById('id_insurance_coverage');
            const premiumInput = document.getElementById('id_premium');

            if (!startDateInput.value) {
                const today = new Date();
                today.setDate(today.getDate() + 1);
                const minDate = today.toISOString().split('T')[0];
                startDateInput.setAttribute('min', minDate);
                startDateInput.value = minDate;
            }

            function updateEndDate() {
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(startDate);
                endDate.setFullYear(startDate.getFullYear() + 1);
                endDateInput.value = endDate.toISOString().split('T')[0];
            }

            if (startDateInput.value) {
                updateEndDate();
            }

            startDateInput.addEventListener('change', updateEndDate);

            coverageSelect.addEventListener('change', function() {
                const selectedOption = coverageSelect.options[coverageSelect.selectedIndex];
                const premiumValue = selectedOption.getAttribute('data-premium');
                if (premiumValue) {
                    premiumInput.value = parseFloat(premiumValue).toFixed(0) + ',- Kč';
                } else {
                    premiumInput.value = '';
                }
            });

            const selectedOption = coverageSelect.querySelector('option:checked');
            const initialPremiumValue = selectedOption ? selectedOption.getAttribute('data-premium') : null;
            if (initialPremiumValue) {
                premiumInput.value = parseFloat(initialPremiumValue).toFixed(0) + ',- Kč';
            }

            if (!endDateInput.value) {
                updateEndDate();
            }
        });
    </script>
{% endblock %}
